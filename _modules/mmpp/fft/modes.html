

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mmpp.fft.modes &mdash; MMPP 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            MMPP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MMPP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mmpp.fft.modes</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mmpp.fft.modes</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">FMR Mode Visualization Module</span>

<span class="sd">Professional implementation for visualizing FMR modes with interactive spectrum.</span>
<span class="sd">Provides both programmatic and interactive interfaces for mode analysis.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gridspec</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Import shared logging configuration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..logging_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_mmpp_logging</span><span class="p">,</span> <span class="n">get_mmpp_logger</span>

<span class="c1"># Get logger for FMR modes</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">get_mmpp_logger</span><span class="p">(</span><span class="s2">&quot;mmpp.fft.modes&quot;</span><span class="p">)</span>

<span class="c1"># Import electromagnetic analysis module</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.electromagnetic_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">ElectromagneticAnalysisConfig</span><span class="p">,</span>
        <span class="n">PoyntingVectorAnalysis</span><span class="p">,</span>
        <span class="n">RadiationPatternAnalysis</span><span class="p">,</span>
        <span class="n">QFactorAnalysis</span><span class="p">,</span>
        <span class="n">analyze_electromagnetic_properties</span><span class="p">,</span>
        <span class="n">create_comprehensive_em_report</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">EM_ANALYSIS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">EM_ANALYSIS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Electromagnetic analysis module not available&quot;</span><span class="p">)</span>

<span class="c1"># Import styling functions from plotting module</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_custom_fonts</span><span class="p">,</span> <span class="n">load_paper_style</span><span class="p">,</span> <span class="n">apply_custom_colors</span>

    <span class="n">STYLING_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">STYLING_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Styling functions not available - using default matplotlib styling&quot;</span><span class="p">)</span>

<span class="c1"># Import electromagnetic analysis module</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.electromagnetic_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">ElectromagneticAnalysisConfig</span><span class="p">,</span>
        <span class="n">PoyntingVectorAnalysis</span><span class="p">,</span>
        <span class="n">RadiationPatternAnalysis</span><span class="p">,</span>
        <span class="n">QFactorAnalysis</span><span class="p">,</span>
        <span class="n">analyze_electromagnetic_properties</span><span class="p">,</span>
        <span class="n">create_comprehensive_em_report</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">EM_ANALYSIS_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">EM_ANALYSIS_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Electromagnetic analysis module not available&quot;</span><span class="p">)</span>

<span class="c1"># Import dependencies with error handling</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>

    <span class="n">ZARR_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">ZARR_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Zarr not available - mode analysis disabled&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.figure</span><span class="w"> </span><span class="kn">import</span> <span class="n">Figure</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.axes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backend_bases</span><span class="w"> </span><span class="kn">import</span> <span class="n">MouseEvent</span>

    <span class="n">MATPLOTLIB_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">MATPLOTLIB_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Matplotlib not available - mode visualization disabled&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_peaks</span>

    <span class="n">SCIPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">SCIPY_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;SciPy not available - peak detection features limited&quot;</span><span class="p">)</span>

<span class="c1"># Check for animation support</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.animation</span><span class="w"> </span><span class="kn">import</span> <span class="n">FuncAnimation</span><span class="p">,</span> <span class="n">PillowWriter</span>

    <span class="n">ANIMATION_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Check for FFmpeg support</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.animation</span><span class="w"> </span><span class="kn">import</span> <span class="n">FFMpegWriter</span>

        <span class="n">FFMPEG_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FFmpeg available for MP4 animations&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">FFMPEG_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FFmpeg not available - MP4 animations will fallback to GIF&quot;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">ANIMATION_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">FFMPEG_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Animation support not available&quot;</span><span class="p">)</span>

<span class="c1"># Check for scientific colormaps</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">cmcrameri.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cmc</span>

    <span class="n">CMCRAMERI_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cmcrameri colormaps available&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">CMCRAMERI_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cmcrameri not available - using standard matplotlib colormaps&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">cmocean</span>

    <span class="n">CMOCEAN_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cmocean colormaps available&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">CMOCEAN_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cmocean not available - using standard matplotlib colormaps&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="MidpointNormalize">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.MidpointNormalize">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MidpointNormalize</span><span class="p">(</span><span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Matplotlib normalization class with symmetric colormap around midpoint.</span>

<span class="sd">    Useful for data that has meaningful zero point (like magnetic field components)</span>
<span class="sd">    where you want symmetric color scaling around zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MidpointNormalize.__init__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.MidpointNormalize.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">midpoint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize normalization.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        vmin : float, optional</span>
<span class="sd">            Minimum value for normalization</span>
<span class="sd">        vmax : float, optional</span>
<span class="sd">            Maximum value for normalization</span>
<span class="sd">        midpoint : float, optional</span>
<span class="sd">            Value that should map to center of colormap (default: 0)</span>
<span class="sd">        clip : bool, optional</span>
<span class="sd">            Whether to clip values outside [vmin, vmax]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span> <span class="o">=</span> <span class="n">midpoint</span>
        <span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span></div>


<div class="viewcode-block" id="MidpointNormalize.__call__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.MidpointNormalize.__call__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply normalization to values.&quot;&quot;&quot;</span>
        <span class="c1"># Handle the case where vmin, vmax, or midpoint could be None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>

        <span class="c1"># Calculate normalized positions for min, mid, max</span>
        <span class="n">normalized_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span>
            <span class="o">/</span> <span class="mi">2</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span><span class="p">))),</span>
        <span class="p">)</span>
        <span class="n">normalized_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span>
            <span class="o">/</span> <span class="mi">2</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span><span class="p">))),</span>
        <span class="p">)</span>
        <span class="n">normalized_mid</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="c1"># Interpolate</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">normalized_min</span><span class="p">,</span> <span class="n">normalized_mid</span><span class="p">,</span> <span class="n">normalized_max</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="setup_animation_styling">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.setup_animation_styling">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_animation_styling</span><span class="p">(</span>
    <span class="n">use_paper_style</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">use_custom_fonts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup styling for FMR mode animations using MMPP paper style.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    use_paper_style : bool, optional</span>
<span class="sd">        Whether to apply paper.mplstyle styling (default: True)</span>
<span class="sd">    use_custom_fonts : bool, optional</span>
<span class="sd">        Whether to setup custom fonts (default: True)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    bool</span>
<span class="sd">        True if styling was successfully applied</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">STYLING_AVAILABLE</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Styling functions not available - using default matplotlib styling&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Setup custom fonts if requested</span>
        <span class="k">if</span> <span class="n">use_custom_fonts</span><span class="p">:</span>
            <span class="n">font_success</span> <span class="o">=</span> <span class="n">setup_custom_fonts</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">font_success</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Custom font setup failed - using default fonts&quot;</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Load paper style if requested</span>
        <span class="k">if</span> <span class="n">use_paper_style</span><span class="p">:</span>
            <span class="n">style_success</span> <span class="o">=</span> <span class="n">load_paper_style</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">style_success</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;✓ Applied paper.mplstyle to mode animations&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Paper style loading failed - using default style&quot;</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Apply custom colors for better visibility</span>
        <span class="n">custom_colors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;#2E2E2E&quot;</span><span class="p">,</span>  <span class="c1"># Dark gray for text</span>
            <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="s2">&quot;#2E2E2E&quot;</span><span class="p">,</span>  <span class="c1"># Dark gray for axes</span>
            <span class="s2">&quot;grid&quot;</span><span class="p">:</span> <span class="s2">&quot;#CCCCCC&quot;</span><span class="p">,</span>  <span class="c1"># Light gray for grid</span>
        <span class="p">}</span>
        <span class="n">apply_custom_colors</span><span class="p">(</span><span class="n">custom_colors</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">success</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animation styling setup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="check_ffmpeg_available">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.check_ffmpeg_available">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_ffmpeg_available</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if ffmpeg is available for MP4 animations.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    bool</span>
<span class="sd">        True if ffmpeg is available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;ffmpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;-version&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="p">(</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">,</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span>
        <span class="ne">FileNotFoundError</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="ModeVisualizationConfig">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.ModeVisualizationConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModeVisualizationConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for mode visualization.&quot;&quot;&quot;</span>

    <span class="c1"># Figure settings</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># Spectrum settings</span>
    <span class="n">spectrum_log_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">spectrum_normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">peak_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">peak_min_distance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="c1"># Mode visualization settings</span>
    <span class="n">show_magnitude</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">show_phase</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">show_combined</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">colormap_magnitude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cmc.berlin&quot;</span>  <span class="c1"># cmcrameri berlin for amplitude data</span>
    <span class="n">colormap_phase</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cmc.romaO&quot;</span>  <span class="c1"># cmcrameri romaO for phase data</span>
    <span class="n">colormap_animation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;balance&quot;</span>  <span class="c1"># cmocean.cm.balance for animations, RdBu_r fallback</span>
    <span class="p">)</span>
    <span class="n">interpolation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;nearest&quot;</span>
    <span class="n">use_midpoint_norm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Use MidpointNormalize for diverging data</span>
    <span class="n">animation_time_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># Number of time steps for one full phase cycle</span>

    <span class="c1"># Frequency range for analysis</span>
    <span class="n">f_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">f_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">40.0</span>

    <span class="c1"># Layout settings</span>
    <span class="n">spectrum_width_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="n">modes_width_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span>

<div class="viewcode-block" id="ModeVisualizationConfig.__post_init__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.ModeVisualizationConfig.__post_init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate configuration parameters.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;f_min (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f_min</span><span class="si">}</span><span class="s2">) must be less than f_max (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">f_max</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_threshold</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_threshold</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;peak_threshold must be between 0 and 1, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_threshold</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_min_distance</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;peak_min_distance must be &gt;= 1, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_min_distance</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_width_ratio</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes_width_ratio</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Width ratios must be positive&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpi</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unusual DPI value: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dpi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Validate colormaps</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_magnitude</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colormap_phase</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Colormap validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve colormap from various sources (cmcrameri, cmocean, matplotlib).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        cmap_name : str</span>
<span class="sd">            Name of the colormap</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        matplotlib colormap object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try cmcrameri first (scientific colormaps)</span>
        <span class="k">if</span> <span class="n">CMCRAMERI_AVAILABLE</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmc</span><span class="p">,</span> <span class="n">cmap_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Try cmocean (oceanographic colormaps)</span>
        <span class="k">if</span> <span class="n">CMOCEAN_AVAILABLE</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">cmocean</span>

                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="p">,</span> <span class="n">cmap_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Fallback to matplotlib</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap_name</span><span class="p">)</span></div>



<div class="viewcode-block" id="Peak">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.Peak">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Peak</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Peak data structure.&quot;&quot;&quot;</span>

    <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">freq</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">amplitude</span><span class="p">:</span> <span class="nb">float</span></div>



<div class="viewcode-block" id="FMRModeData">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FMRModeData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Container for FMR mode data at a specific frequency.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FMRModeData.__init__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeData.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">mode_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">extent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize FMR mode data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        frequency : float</span>
<span class="sd">            Frequency in GHz</span>
<span class="sd">        mode_array : np.ndarray</span>
<span class="sd">            Complex mode array with shape (ny, nx, 3) for spatial x-y and magnetization components</span>
<span class="sd">        extent : tuple, optional</span>
<span class="sd">            Spatial extent [x_min, x_max, y_min, y_max] in nm</span>
<span class="sd">        metadata : dict, optional</span>
<span class="sd">            Additional metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_array</span> <span class="o">=</span> <span class="n">mode_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">=</span> <span class="n">extent</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># Validate input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;mode_array must be numpy array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode_array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">mode_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mode_array must have shape (ny, nx, 3)&quot;</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">magnitude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get magnitude of mode for each component.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_array</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">phase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get phase of mode for each component.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_array</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_magnitude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get total magnitude across all components.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

<div class="viewcode-block" id="FMRModeData.get_component">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeData.get_component">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get specific magnetization component.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        component : int or str</span>
<span class="sd">            Component index (0, 1, 2) or name (&#39;x&#39;, &#39;y&#39;, &#39;z&#39;, &#39;mx&#39;, &#39;my&#39;, &#39;mz&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Complex mode array for specified component</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">component_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;mx&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;my&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">component_map</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unknown component &#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">&#39;. Use &#39;x&#39;, &#39;y&#39;, &#39;z&#39; or 0, 1, 2&quot;</span>
                <span class="p">)</span>
            <span class="n">component</span> <span class="o">=</span> <span class="n">component_map</span><span class="p">[</span><span class="n">component</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">component</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Component index must be 0, 1, or 2, got </span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">component</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="FMRModeAnalyzer">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeAnalyzer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FMRModeAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Professional FMR mode analyzer with interactive visualization.</span>

<span class="sd">    Provides both programmatic access to mode data and interactive</span>
<span class="sd">    spectrum visualization for frequency selection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FMRModeAnalyzer.__init__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeAnalyzer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">zarr_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModeVisualizationConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize FMR mode analyzer.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        zarr_path : str</span>
<span class="sd">            Path to zarr file containing mode data</span>
<span class="sd">        dataset_name : str, optional</span>
<span class="sd">            Base dataset name (default: &quot;m&quot;)</span>
<span class="sd">        config : ModeVisualizationConfig, optional</span>
<span class="sd">            Visualization configuration</span>
<span class="sd">        debug : bool, optional</span>
<span class="sd">            Enable debug logging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ZARR_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Zarr is required for mode analysis&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zarr_path</span> <span class="o">=</span> <span class="n">zarr_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">=</span> <span class="n">dataset_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">ModeVisualizationConfig</span><span class="p">()</span>

        <span class="c1"># Set up logging</span>
        <span class="n">setup_mmpp_logging</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">logger_name</span><span class="o">=</span><span class="s2">&quot;mmpp.fft.modes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FMR mode analyzer debug logging enabled&quot;</span><span class="p">)</span>

        <span class="c1"># Load data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">()</span>

        <span class="c1"># Interactive state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_frequency</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frequency_line</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Mode data cache (LRU cache with max 10 entries)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_cache_size</span> <span class="o">=</span> <span class="mi">10</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">modes_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if mode data is available.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modes_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_zarr_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unified path resolution for zarr datasets.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        Tuple[str, str, str]</span>
<span class="sd">            (modes_path, freqs_path, spectrum_path) or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Possible base paths for modes/frequencies - consistent order</span>
        <span class="n">base_paths</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;modes/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tmodes/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="n">modes_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">freqs_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Find first existing base path</span>
        <span class="k">for</span> <span class="n">base_path</span> <span class="ow">in</span> <span class="n">base_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/arr&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span>
                <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/freqs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span>
            <span class="p">):</span>
                <span class="n">modes_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/arr&quot;</span>
                <span class="n">freqs_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/freqs&quot;</span>
                <span class="k">break</span>

        <span class="c1"># If not found together, try separately (for backward compatibility)</span>
        <span class="k">if</span> <span class="n">modes_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">base_path</span> <span class="ow">in</span> <span class="n">base_paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/arr&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">:</span>
                    <span class="n">modes_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/arr&quot;</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">freqs_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">base_path</span> <span class="ow">in</span> <span class="n">base_paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/freqs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">:</span>
                    <span class="n">freqs_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s2">/freqs&quot;</span>
                    <span class="k">break</span>

        <span class="c1"># Find spectrum</span>
        <span class="n">spectrum_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">spectrum_candidates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;fft/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/spec&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;fft/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/sum&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">spectrum_candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">:</span>
                <span class="n">spectrum_path</span> <span class="o">=</span> <span class="n">path</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">modes_path</span><span class="p">,</span> <span class="n">freqs_path</span><span class="p">,</span> <span class="n">spectrum_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load mode and spectrum data from zarr file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opened zarr file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open zarr file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Use unified path resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_zarr_paths</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes_path</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No mode data found for dataset &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="s2">&quot;Modes will need to be computed.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs_path</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No frequency data found for dataset &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="s2">&quot;Frequencies will be computed with modes.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_path</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No spectrum data found for dataset &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Expected paths: fft/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/spec or fft/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/sum&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Load frequency array if available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs_path</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Loaded frequencies: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span><span class="si">}</span><span class="s2"> points, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;range </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No frequency data loaded - will be computed with modes&quot;</span><span class="p">)</span>

        <span class="c1"># Load spectrum if available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum_path</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Take first component if multi-component</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">ndim</span><span class="p">)))</span>
                <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded spectrum data: shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Get spatial information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_spatial_info</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_spatial_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract spatial information from zarr metadata.&quot;&quot;&quot;</span>
        <span class="c1"># Try to get spatial resolution from attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Default spatial resolution in nm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Look for spatial attributes in various locations</span>
        <span class="n">attrs_to_check</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span>
                <span class="k">else</span> <span class="p">{}</span>
            <span class="p">),</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">attrs_to_check</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;dx&quot;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e9</span>  <span class="c1"># Convert to nm</span>
            <span class="k">if</span> <span class="s2">&quot;dy&quot;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;dy&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e9</span>  <span class="c1"># Convert to nm</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spatial resolution: dx=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nm, dy=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_peaks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Peak</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect peaks in spectrum.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        spectrum : np.ndarray</span>
<span class="sd">            Power spectrum data</span>
<span class="sd">        frequencies : np.ndarray</span>
<span class="sd">            Frequency array in GHz</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        List[Peak]</span>
<span class="sd">            List of detected peaks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SCIPY_AVAILABLE</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;SciPy not available, using simple peak detection&quot;</span><span class="p">)</span>
            <span class="c1"># Simple peak detection without scipy</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">peak_threshold</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Peak</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">frequencies</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">peaks</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Normalize spectrum for peak detection</span>
            <span class="n">norm_spectrum</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

            <span class="c1"># Find peaks using scipy</span>
            <span class="n">peak_indices</span><span class="p">,</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span>
                <span class="n">norm_spectrum</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">peak_threshold</span><span class="p">,</span>
                <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">peak_min_distance</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Create peak objects</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">peak_indices</span><span class="p">:</span>
                <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Peak</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="n">frequencies</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">spectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="p">)</span>

            <span class="c1"># Sort by amplitude (descending)</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span><span class="si">}</span><span class="s2"> peaks&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">peaks</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peak detection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="FMRModeAnalyzer.get_mode">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeAnalyzer.get_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FMRModeData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get mode data at specified frequency.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        frequency : float</span>
<span class="sd">            Frequency in GHz</span>
<span class="sd">        z_layer : int, optional</span>
<span class="sd">            Z-layer index (default: 0)</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        FMRModeData</span>
<span class="sd">            Mode data at specified frequency</span>

<span class="sd">        Raises:</span>
<span class="sd">        -------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If frequency or z_layer is out of range</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If mode data is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;No frequency data available. Run compute_modes() first.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No mode data available. Run compute_modes() first.&quot;</span><span class="p">)</span>

        <span class="c1"># Find closest frequency index</span>
        <span class="n">freq_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">-</span> <span class="n">frequency</span><span class="p">))</span>
        <span class="n">actual_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="n">freq_idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual_freq</span> <span class="o">-</span> <span class="n">frequency</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Requested frequency </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz not found, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;using closest: </span><span class="si">{</span><span class="n">actual_freq</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate z_layer bounds</span>
        <span class="n">mode_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modes_path</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">z_layer</span> <span class="o">&gt;=</span> <span class="n">mode_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;z_layer </span><span class="si">{</span><span class="n">z_layer</span><span class="si">}</span><span class="s2"> out of range. Available layers: 0-</span><span class="si">{</span><span class="n">mode_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Load mode data for this frequency with bounds checking</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mode_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modes_path</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid indices: freq_idx=</span><span class="si">{</span><span class="n">freq_idx</span><span class="si">}</span><span class="s2">, z_layer=</span><span class="si">{</span><span class="n">z_layer</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Create spatial extent</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">mode_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ny</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">)</span>

        <span class="c1"># Metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;frequency_index&quot;</span><span class="p">:</span> <span class="n">freq_idx</span><span class="p">,</span>
            <span class="s2">&quot;requested_frequency&quot;</span><span class="p">:</span> <span class="n">frequency</span><span class="p">,</span>
            <span class="s2">&quot;actual_frequency&quot;</span><span class="p">:</span> <span class="n">actual_freq</span><span class="p">,</span>
            <span class="s2">&quot;z_layer&quot;</span><span class="p">:</span> <span class="n">z_layer</span><span class="p">,</span>
            <span class="s2">&quot;spatial_resolution&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">),</span>
            <span class="s2">&quot;mode_shape&quot;</span><span class="p">:</span> <span class="n">mode_shape</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Update cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">(</span>
            <span class="n">frequency</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">,</span> <span class="n">FMRModeData</span><span class="p">(</span><span class="n">actual_freq</span><span class="p">,</span> <span class="n">mode_data</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">FMRModeData</span><span class="p">(</span><span class="n">actual_freq</span><span class="p">,</span> <span class="n">mode_data</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_cache</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mode_data</span><span class="p">:</span> <span class="n">FMRModeData</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mode data cache.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_cache</span><span class="p">:</span>
            <span class="c1"># Move to end to indicate recent use</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode_cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_cache_size</span><span class="p">:</span>
            <span class="c1"># Remove least recently used item</span>
            <span class="n">oldest_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_order</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_cache</span><span class="p">[</span><span class="n">oldest_key</span><span class="p">]</span>

        <span class="c1"># Update cache with new mode data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="FMRModeAnalyzer.find_peaks">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeAnalyzer.find_peaks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_peaks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_distance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Peak</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find peaks in the spectrum.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            Peak detection threshold (default: from config)</span>
<span class="sd">        min_distance : int, optional</span>
<span class="sd">            Minimum distance between peaks (default: from config)</span>
<span class="sd">        component : int, optional</span>
<span class="sd">            Spectrum component to analyze (default: 0)</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        List[Peak]</span>
<span class="sd">            List of detected peaks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No spectrum data available for peak detection&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">peak_threshold</span>
        <span class="n">min_distance</span> <span class="o">=</span> <span class="n">min_distance</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">peak_min_distance</span>

        <span class="c1"># Normalize spectrum for peak detection</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">spectrum_normalize</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

        <span class="c1"># Filter frequency range</span>
        <span class="n">freq_mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">f_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">f_max</span>
        <span class="p">)</span>
        <span class="n">freqs_filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="n">freq_mask</span><span class="p">]</span>
        <span class="n">spectrum_filtered</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">freq_mask</span><span class="p">]</span>

        <span class="c1"># Detect peaks</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_peaks</span><span class="p">(</span><span class="n">spectrum_filtered</span><span class="p">,</span> <span class="n">freqs_filtered</span><span class="p">)</span>

        <span class="c1"># Convert to Peak objects with proper index mapping</span>
        <span class="n">peaks_converted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="c1"># Safely map back to original index</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">orig_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">freq_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">peak</span><span class="o">.</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_indices</span><span class="p">):</span>
                    <span class="n">orig_idx</span> <span class="o">=</span> <span class="n">orig_indices</span><span class="p">[</span><span class="n">peak</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">peaks_converted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Peak</span><span class="p">(</span><span class="n">orig_idx</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">amplitude</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Peak index </span><span class="si">{</span><span class="n">peak</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> out of range for filtered array&quot;</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index mapping error for peak </span><span class="si">{</span><span class="n">peak</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks_converted</span><span class="p">)</span><span class="si">}</span><span class="s2"> peaks in frequency range &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">f_min</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">f_max</span><span class="si">}</span><span class="s2"> GHz&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">peaks_converted</span></div>


<div class="viewcode-block" id="FMRModeAnalyzer.plot_modes">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeAnalyzer.plot_modes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_modes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">z_layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Figure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot mode visualization for a specific frequency.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        frequency : float</span>
<span class="sd">            Frequency in GHz</span>
<span class="sd">        z_layer : int, optional</span>
<span class="sd">            Z-layer index (default: 0)</span>
<span class="sd">        components : list, optional</span>
<span class="sd">            List of components to plot (default: [&#39;x&#39;, &#39;y&#39;, &#39;z&#39;])</span>
<span class="sd">        save_path : str, optional</span>
<span class="sd">            Path to save the figure</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        Tuple[Figure, np.ndarray]</span>
<span class="sd">            Matplotlib figure and axes array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MATPLOTLIB_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Matplotlib is required for plotting&quot;</span><span class="p">)</span>

        <span class="c1"># Setup professional styling for mode plots</span>
        <span class="n">setup_animation_styling</span><span class="p">(</span><span class="n">use_paper_style</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_custom_fonts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">components</span> <span class="o">=</span> <span class="n">components</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="n">mode_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">)</span>

        <span class="c1"># Create figure with subplots</span>
        <span class="n">n_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">3</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_magnitude</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_phase</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_combined</span>
            <span class="k">else</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">n_rows</span><span class="p">,</span>
            <span class="n">n_components</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">n_components</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">),</span>
            <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dpi</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">n_components</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Plot each component</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
            <span class="n">comp_data</span> <span class="o">=</span> <span class="n">mode_data</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="n">magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">comp_data</span><span class="p">)</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">comp_data</span><span class="p">)</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Magnitude plot</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_magnitude</span><span class="p">:</span>
                <span class="n">im1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">magnitude</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_resolve_colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colormap_magnitude</span><span class="p">),</span>
                    <span class="n">extent</span><span class="o">=</span><span class="n">mode_data</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                    <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;|m_</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">| @ </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x (nm)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y (nm)&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Phase plot</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_phase</span><span class="p">:</span>
                <span class="n">im2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">phase</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_resolve_colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colormap_phase</span><span class="p">),</span>
                    <span class="n">extent</span><span class="o">=</span><span class="n">mode_data</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                    <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;arg(m_</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">) @ </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x (nm)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y (nm)&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Combined plot (phase with magnitude as alpha)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_combined</span><span class="p">:</span>
                <span class="c1"># Create combined visualization: magnitude * cos(phase) for real part</span>
                <span class="n">combined_data</span> <span class="o">=</span> <span class="n">magnitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>  <span class="c1"># Real part</span>
                <span class="c1"># Alternative: combined_data = magnitude * np.sin(phase)  # Imaginary part</span>

                <span class="n">im3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">combined_data</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_resolve_colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colormap_phase</span><span class="p">),</span>
                    <span class="n">extent</span><span class="o">=</span><span class="n">mode_data</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                    <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;m_</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2"> combined (mag×cos(φ)) @ </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span>
                <span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x (nm)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y (nm)&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved mode plot to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="FMRModeAnalyzer.interactive_spectrum">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeAnalyzer.interactive_spectrum">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">interactive_spectrum</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">z_layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create interactive spectrum plot with mode visualization.</span>

<span class="sd">        Click on spectrum to select frequency and visualize corresponding mode.</span>
<span class="sd">        Right-click to snap to nearest peak.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        components : list, optional</span>
<span class="sd">            List of components to plot (default: [&#39;x&#39;, &#39;y&#39;, &#39;z&#39;])</span>
<span class="sd">        z_layer : int, optional</span>
<span class="sd">            Z-layer index (default: 0)</span>
<span class="sd">        method : int, optional</span>
<span class="sd">            Visualization method (default: 1)</span>
<span class="sd">            1 = Standard interactive plot</span>
<span class="sd">            2 = Alternative layout (if implemented)</span>
<span class="sd">        show : bool, optional</span>
<span class="sd">            Whether to automatically display the figure (default: True)</span>
<span class="sd">        \\*\\*kwargs : dict</span>
<span class="sd">            Additional keyword arguments:</span>
<span class="sd">            - figsize : tuple, optional</span>
<span class="sd">                Figure size (width, height) in inches (default: from config)</span>
<span class="sd">            - dpi : int, optional</span>
<span class="sd">                Figure resolution in dots per inch (default: from config)</span>
<span class="sd">            - cmap : str, optional</span>
<span class="sd">                Colormap for all mode visualizations (overrides config colormaps)</span>
<span class="sd">                Examples: &#39;viridis&#39;, &#39;inferno&#39;, &#39;plasma&#39;, &#39;cividis&#39;, &#39;balance&#39;</span>
<span class="sd">            - acmap : str, optional</span>
<span class="sd">                Colormap specifically for amplitude/magnitude plots (overrides cmap for magnitude)</span>
<span class="sd">                Examples: &#39;viridis&#39;, &#39;inferno&#39;, &#39;plasma&#39;, &#39;hot&#39;</span>
<span class="sd">            - pcmap : str, optional</span>
<span class="sd">                Colormap specifically for phase plots (overrides cmap for phase)</span>
<span class="sd">                Examples: &#39;hsv&#39;, &#39;twilight&#39;, &#39;twilight_shifted&#39;, &#39;phase&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        Figure</span>
<span class="sd">            Interactive matplotlib figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MATPLOTLIB_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Matplotlib is required for interactive plotting&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No spectrum data available for interactive mode&quot;</span><span class="p">)</span>

        <span class="c1"># Apply paper style for consistent visualization</span>
        <span class="k">if</span> <span class="n">STYLING_AVAILABLE</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">load_paper_style</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Applied paper style to interactive spectrum&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not apply paper style: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Handle method parameter</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">, using default method 1&quot;</span><span class="p">)</span>
            <span class="n">method</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">components</span> <span class="o">=</span> <span class="n">components</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="n">n_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>

        <span class="c1"># Extract parameters from kwargs</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dpi&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cmap&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">acmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;acmap&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Amplitude/magnitude colormap</span>
        <span class="n">pcmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pcmap&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Phase colormap</span>

        <span class="c1"># Update colormaps if provided</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">or</span> <span class="n">acmap</span> <span class="ow">or</span> <span class="n">pcmap</span><span class="p">:</span>
            <span class="c1"># Create a temporary copy of config with updated colormaps</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

            <span class="n">temp_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

            <span class="c1"># If cmap is provided, use it for all types unless specifically overridden</span>
            <span class="k">if</span> <span class="n">cmap</span><span class="p">:</span>
                <span class="n">temp_config</span><span class="o">.</span><span class="n">colormap_magnitude</span> <span class="o">=</span> <span class="n">cmap</span>
                <span class="n">temp_config</span><span class="o">.</span><span class="n">colormap_phase</span> <span class="o">=</span> <span class="n">cmap</span>

            <span class="c1"># Override with specific colormaps if provided</span>
            <span class="k">if</span> <span class="n">acmap</span><span class="p">:</span>
                <span class="n">temp_config</span><span class="o">.</span><span class="n">colormap_magnitude</span> <span class="o">=</span> <span class="n">acmap</span>
            <span class="k">if</span> <span class="n">pcmap</span><span class="p">:</span>
                <span class="n">temp_config</span><span class="o">.</span><span class="n">colormap_phase</span> <span class="o">=</span> <span class="n">pcmap</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">temp_config</span>

        <span class="c1"># Update figure settings from kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span>

        <span class="c1"># Validate number of components for layout</span>
        <span class="k">if</span> <span class="n">n_components</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Too many components (</span><span class="si">{</span><span class="n">n_components</span><span class="si">}</span><span class="s2">). Maximum supported: 5&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Create figure with custom layout</span>
        <span class="c1"># Try to use interactive backend if available, but don&#39;t force it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>

            <span class="n">current_backend</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;ipympl&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="ow">and</span> <span class="s2">&quot;widget&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Current backend: </span><span class="si">{</span><span class="n">current_backend</span><span class="si">}</span><span class="s2">. Interactive features may be limited.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not check matplotlib backend: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>

        <span class="c1"># Create grid layout: spectrum on left, modes on right</span>
        <span class="c1"># Use dynamic number of rows (3 for all visualization types)</span>
        <span class="n">n_vis_types</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_magnitude</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_phase</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_combined</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">n_vis_types</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one visualization type must be enabled&quot;</span><span class="p">)</span>

        <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span>
            <span class="n">n_vis_types</span><span class="p">,</span>
            <span class="n">n_components</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">spectrum_width_ratio</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">modes_width_ratio</span> <span class="o">/</span> <span class="n">n_components</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_components</span><span class="p">,</span>
            <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_vis_types</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Spectrum plot spans all rows in first column</span>
        <span class="n">ax_spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Mode plots in remaining columns - dynamic based on enabled visualizations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_components</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vis_types</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Plot spectrum</span>
        <span class="n">freq_mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">f_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">f_max</span>
        <span class="p">)</span>
        <span class="n">freqs_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="n">freq_mask</span><span class="p">]</span>
        <span class="n">spectrum_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="n">freq_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">spectrum_normalize</span><span class="p">:</span>
            <span class="n">spectrum_plot</span> <span class="o">=</span> <span class="n">spectrum_plot</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum_plot</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">spectrum_log_scale</span><span class="p">:</span>
            <span class="n">spectrum_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">spectrum_plot</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="n">ax_spectrum</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;log₁₀(Power Spectrum)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax_spectrum</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Power Spectrum&quot;</span><span class="p">)</span>

        <span class="n">ax_spectrum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs_plot</span><span class="p">,</span> <span class="n">spectrum_plot</span><span class="p">,</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">ax_spectrum</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (GHz)&quot;</span><span class="p">)</span>
        <span class="n">ax_spectrum</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;FMR Spectrum (Click to select frequency)&quot;</span><span class="p">)</span>
        <span class="n">ax_spectrum</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Find and mark peaks</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">f_min</span> <span class="o">&lt;=</span> <span class="n">peak</span><span class="o">.</span><span class="n">freq</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">f_max</span><span class="p">:</span>
                <span class="n">y_val</span> <span class="o">=</span> <span class="n">spectrum_plot</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freqs_plot</span> <span class="o">-</span> <span class="n">peak</span><span class="o">.</span><span class="n">freq</span><span class="p">))]</span>
                <span class="n">ax_spectrum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">y_val</span><span class="p">,</span> <span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">ax_spectrum</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">peak</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>
                    <span class="n">y_val</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum_plot</span><span class="p">),</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">peak</span><span class="o">.</span><span class="n">freq</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Initial frequency line</span>
        <span class="n">init_freq</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">freq</span> <span class="k">if</span> <span class="n">peaks</span> <span class="k">else</span> <span class="n">freqs_plot</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs_plot</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frequency_line</span> <span class="o">=</span> <span class="n">ax_spectrum</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
            <span class="n">init_freq</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span>
        <span class="p">)</span>

        <span class="c1"># Plot initial mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_frequency</span> <span class="o">=</span> <span class="n">init_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_mode_plots</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">)</span>

        <span class="c1"># Set up click handler with proper cleanup</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">on_click</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="o">==</span> <span class="n">ax_spectrum</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Right click - snap to peak</span>
                    <span class="k">if</span> <span class="n">peaks</span><span class="p">:</span>
                        <span class="n">peak_freqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">freq</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>
                        <span class="n">closest_peak_freq</span> <span class="o">=</span> <span class="n">peak_freqs</span><span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak_freqs</span><span class="p">)</span> <span class="o">-</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">))</span>
                        <span class="p">]</span>
                        <span class="n">selected_freq</span> <span class="o">=</span> <span class="n">closest_peak_freq</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">selected_freq</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Left click - exact frequency</span>
                    <span class="n">selected_freq</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>

                <span class="c1"># Update frequency line and mode plots</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_frequency_line</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">([</span><span class="n">selected_freq</span><span class="p">,</span> <span class="n">selected_freq</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_frequency</span> <span class="o">=</span> <span class="n">selected_freq</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_mode_plots</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="c1"># Store event connection for cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_click_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span>
            <span class="s2">&quot;button_press_event&quot;</span><span class="p">,</span> <span class="n">on_click</span>
        <span class="p">)</span>

        <span class="c1"># Add cleanup method to figure</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_click_connection&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_click_connection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_click_connection</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_click_connection</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Interactive plot event handlers cleaned up&quot;</span><span class="p">)</span>

        <span class="c1"># Store cleanup function for later use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span><span class="o">.</span><span class="n">_mmpp_cleanup</span> <span class="o">=</span> <span class="n">cleanup</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Interactive spectrum plot created. Click to select frequency, right-click to snap to peaks.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Control figure display to avoid double showing</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Don&#39;t return figure to avoid Jupyter auto-display</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_mode_plots</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">components</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">z_layer</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mode plots for current frequency.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Clear all axes</span>
        <span class="k">for</span> <span class="n">ax_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_row</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

        <span class="c1"># Get mode data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mode_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_frequency</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get mode data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Show error message on plots instead of leaving them empty</span>
            <span class="k">for</span> <span class="n">ax_row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">ax_row</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                        <span class="mf">0.5</span><span class="p">,</span>
                        <span class="mf">0.5</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Error loading mode data:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                        <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Plot each component</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">comp_data</span> <span class="o">=</span> <span class="n">mode_data</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
                <span class="n">magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">comp_data</span><span class="p">)</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">comp_data</span><span class="p">)</span>

                <span class="n">row_idx</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Magnitude plot (if enabled)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_magnitude</span><span class="p">:</span>
                    <span class="n">im1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                        <span class="n">magnitude</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_resolve_colormap</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colormap_magnitude</span>
                        <span class="p">),</span>
                        <span class="n">extent</span><span class="o">=</span><span class="n">mode_data</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                        <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;|m_</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">|&quot;</span><span class="p">)</span>
                    <span class="n">row_idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Phase plot (if enabled)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_phase</span><span class="p">:</span>
                    <span class="n">im2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                        <span class="n">phase</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_resolve_colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colormap_phase</span><span class="p">),</span>
                        <span class="n">extent</span><span class="o">=</span><span class="n">mode_data</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                        <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                        <span class="n">vmin</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                        <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;arg(m_</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="n">row_idx</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Combined plot (if enabled)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_combined</span><span class="p">:</span>
                    <span class="c1"># Create combined visualization: magnitude * cos(phase) for real part</span>
                    <span class="c1"># or magnitude * sin(phase) for imaginary part</span>
                    <span class="c1"># This shows the actual complex amplitude with sign</span>
                    <span class="n">combined_data</span> <span class="o">=</span> <span class="n">magnitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>  <span class="c1"># Real part</span>
                    <span class="c1"># Alternative: combined_data = magnitude * np.sin(phase)  # Imaginary part</span>

                    <span class="n">im3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                        <span class="n">combined_data</span><span class="p">,</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_resolve_colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colormap_phase</span><span class="p">),</span>
                        <span class="n">extent</span><span class="o">=</span><span class="n">mode_data</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                        <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mode_axes</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;m_</span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2"> combined (mag×cos(φ))&quot;</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to plot component </span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># Add frequency info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;FMR Modes at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="FMRModeAnalyzer.compute_modes">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeAnalyzer.compute_modes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_modes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">z_slice</span><span class="p">:</span> <span class="nb">slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">window</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute FMR modes from magnetization data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        z_slice : slice</span>
<span class="sd">            Z-layer slice to process</span>
<span class="sd">        window : bool</span>
<span class="sd">            Apply Hanning window</span>
<span class="sd">        save : bool</span>
<span class="sd">            Save results to zarr</span>
<span class="sd">        force : bool</span>
<span class="sd">            Force recomputation even if data exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;modes/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/arr&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Mode data already exists, use force=True to recompute&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing FMR modes for dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Remove existing data if force=True</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Open in write mode for deletion</span>
                <span class="n">zarr_write</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;modes/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">zarr_write</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">zarr_write</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;modes/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed existing modes data for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;fft/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">zarr_write</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">zarr_write</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fft/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed existing FFT data for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">zarr_write</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="c1"># Important: Reopen in read mode and reload data paths</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">()</span>  <span class="c1"># Reload paths after deletion</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not remove existing data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Continue anyway - might be permission issue</span>

        <span class="c1"># Load magnetization data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2"> not found in zarr&quot;</span><span class="p">)</span>

        <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">]</span>

        <span class="c1"># Get time array</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">t_array</span> <span class="o">=</span> <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">][:]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_array</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Fallback to dt from zarr attrs</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">))</span>
            <span class="n">t_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">dt</span>

        <span class="c1"># Calculate frequencies</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_array</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-9</span>  <span class="c1"># Convert to GHz</span>

        <span class="c1"># Load and process data</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading magnetization data: </span><span class="si">{</span><span class="n">dset</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dset</span><span class="p">[:,</span> <span class="n">z_slice</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading magnetization data finished&quot;</span><span class="p">)</span>

        <span class="c1"># Remove DC component</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">-</span> <span class="n">arr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

        <span class="c1"># Apply window function</span>
        <span class="k">if</span> <span class="n">window</span><span class="p">:</span>
            <span class="n">window_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">window_func</span> <span class="o">=</span> <span class="n">window_func</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">*</span> <span class="n">window_func</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applied Hanning window&quot;</span><span class="p">)</span>

        <span class="c1"># Compute FFT</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing FFT...&quot;</span><span class="p">)</span>
        <span class="n">fft_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing FFT finished.&quot;</span><span class="p">)</span>

        <span class="c1"># Save results</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving mode data...&quot;</span><span class="p">)</span>

            <span class="c1"># Open in write mode</span>
            <span class="n">zarr_write</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>

            <span class="c1"># Create groups</span>
            <span class="n">modes_group</span> <span class="o">=</span> <span class="n">zarr_write</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;modes/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fft_group</span> <span class="o">=</span> <span class="n">zarr_write</span><span class="o">.</span><span class="n">require_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fft/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Save frequencies</span>
            <span class="n">modes_group</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fft_group</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;freqs&quot;</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Save complex modes (chunked only on first dimension)</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">fft_result</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">modes_group</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="s2">&quot;arr&quot;</span><span class="p">,</span> <span class="n">fft_result</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Save power spectrum</span>
            <span class="n">power_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fft_result</span><span class="p">)</span>
            <span class="n">fft_group</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="s2">&quot;spec&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">power_spec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">fft_group</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">power_spec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Save metadata</span>
            <span class="n">modes_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;computed_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">modes_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;window_applied&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">window</span>
            <span class="n">modes_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;z_slice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">z_slice</span><span class="p">)</span>
            <span class="n">modes_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>

            <span class="c1"># zarr groups don&#39;t have close() method, just let it go out of scope</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;✅ Mode computation completed and saved&quot;</span><span class="p">)</span>

        <span class="c1"># Reload data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zarr_file</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zarr_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">()</span></div>


<div class="viewcode-block" id="FMRModeAnalyzer.save_modes_animation">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FMRModeAnalyzer.save_modes_animation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_modes_animation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frequency_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mode_animation.gif&quot;</span><span class="p">,</span>
        <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
        <span class="n">z_layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
        <span class="n">animation_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;temporal&quot;</span><span class="p">,</span>
        <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_midpoint_norm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save animation of FMR modes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        frequency_range : tuple, optional</span>
<span class="sd">            (f_min, f_max) in GHz for frequency sweep animation</span>
<span class="sd">        frequency : float, optional</span>
<span class="sd">            Single frequency for temporal animation (in GHz)</span>
<span class="sd">        save_path : str</span>
<span class="sd">            Output file path (.gif or .mp4)</span>
<span class="sd">        fps : int</span>
<span class="sd">            Frames per second (default: 15)</span>
<span class="sd">        z_layer : int</span>
<span class="sd">            Z-layer to animate (default: 0)</span>
<span class="sd">        component : str or int</span>
<span class="sd">            Component to animate (default: &#39;z&#39;)</span>
<span class="sd">        animation_type : str</span>
<span class="sd">            Type of animation:</span>
<span class="sd">            - &#39;temporal&#39;: Real part of mode oscillating in time at fixed frequency</span>
<span class="sd">            - &#39;frequency&#39;: Mode amplitude across frequency range</span>
<span class="sd">            - &#39;phase&#39;: Phase evolution at fixed frequency</span>
<span class="sd">        colormap : str, optional</span>
<span class="sd">            Colormap name. If None, uses config defaults</span>
<span class="sd">        use_midpoint_norm : bool, optional</span>
<span class="sd">            Use symmetric normalization around zero (default: from config)</span>
<span class="sd">        figsize : tuple, optional</span>
<span class="sd">            Figure size (width, height)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MATPLOTLIB_AVAILABLE</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ANIMATION_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Matplotlib and animation support are required for animations&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Setup professional styling for animations</span>
        <span class="n">setup_animation_styling</span><span class="p">(</span><span class="n">use_paper_style</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_custom_fonts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.animation</span><span class="w"> </span><span class="kn">import</span> <span class="n">FuncAnimation</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>

            <span class="c1"># Parameter validation</span>
            <span class="k">if</span> <span class="n">frequency_range</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">frequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either frequency_range or frequency must be specified&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">frequency_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Specify either frequency_range OR frequency, not both&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Set defaults with intelligent choices for animation type</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">colormap_animation</span>

            <span class="c1"># Auto-enable MidpointNormalize for temporal animations if not explicitly set</span>
            <span class="k">if</span> <span class="n">use_midpoint_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">animation_type</span> <span class="o">==</span> <span class="s2">&quot;temporal&quot;</span><span class="p">:</span>
                    <span class="n">use_midpoint_norm</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="kc">True</span>  <span class="c1"># Temporal animations benefit from symmetric normalization</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">use_midpoint_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_midpoint_norm</span>

            <span class="c1"># Choose better colormap for temporal oscillations if default &#39;balance&#39;</span>
            <span class="k">if</span> <span class="n">animation_type</span> <span class="o">==</span> <span class="s2">&quot;temporal&quot;</span> <span class="ow">and</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;balance&quot;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Using diverging colormap &#39;balance&#39; - perfect for oscillating modes&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Try to get cmocean colormaps for better scientific visualization</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">cmocean</span>

                <span class="k">if</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;balance&quot;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">balance</span>  <span class="c1"># Perfect for data with +/- symmetry</span>
                <span class="k">elif</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;diff&quot;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">diff</span>  <span class="c1"># Another good diverging colormap</span>
                <span class="k">elif</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;curl&quot;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">curl</span>  <span class="c1"># Good for circular/phase data</span>
                <span class="k">elif</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;delta&quot;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">delta</span>  <span class="c1"># Good for deviations from mean</span>
                <span class="k">elif</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;tarn&quot;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmocean</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tarn</span>  <span class="c1"># Good for complex data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Try as regular matplotlib colormap</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;cmocean not available, using matplotlib colormaps&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;balance&quot;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;RdBu_r&quot;</span><span class="p">)</span>  <span class="c1"># Best fallback for balance</span>
                <span class="k">elif</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;diff&quot;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;RdBu&quot;</span><span class="p">)</span>  <span class="c1"># Alternative diverging</span>
                <span class="k">elif</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;curl&quot;</span> <span class="ow">or</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;tarn&quot;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;RdYlBu_r&quot;</span><span class="p">)</span>  <span class="c1"># Complex fallback</span>
                <span class="k">elif</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s2">&quot;delta&quot;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;PuOr_r&quot;</span><span class="p">)</span>  <span class="c1"># Another diverging option</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

            <span class="c1"># Setup figure</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">animation_type</span> <span class="o">==</span> <span class="s2">&quot;temporal&quot;</span> <span class="ow">and</span> <span class="n">frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Temporal animation: Real part oscillating in time (true physical dynamics)</span>
                <span class="c1"># Shows how the mode would actually oscillate at this frequency</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating temporal animation at </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span><span class="p">)</span>

                <span class="c1"># Get mode data</span>
                <span class="n">mode_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">)</span>
                <span class="n">comp_data</span> <span class="o">=</span> <span class="n">mode_data</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

                <span class="c1"># Get amplitude and phase - this is the complex mode from FFT</span>
                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">comp_data</span><span class="p">)</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">comp_data</span><span class="p">)</span>

                <span class="c1"># Setup normalization - MidpointNormalize is perfect for oscillating data</span>
                <span class="k">if</span> <span class="n">use_midpoint_norm</span><span class="p">:</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>
                    <span class="n">norm</span> <span class="o">=</span> <span class="n">MidpointNormalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">midpoint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>
                    <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

                <span class="c1"># Time steps for one full oscillation period</span>
                <span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">animation_time_steps</span><span class="p">)</span>

                <span class="c1"># Create initial plot for colorbar setup</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">time_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">real_part</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">real_part</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                    <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                    <span class="n">extent</span><span class="o">=</span><span class="n">mode_data</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
                    <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Create colorbar once</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Magnetization (arb. units)&quot;</span><span class="p">)</span>

                <span class="c1"># Set labels once (they won&#39;t change)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x (nm)&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y (nm)&quot;</span><span class="p">)</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">animate_temporal</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
                    <span class="c1"># Calculate real part at this time step: Re[A * e^(i*φ) * e^(i*ω*t)]</span>
                    <span class="c1"># This is exactly: amplitude * cos(phase + ωt) where ωt = time_steps[frame]</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">time_steps</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
                    <span class="n">real_part</span> <span class="o">=</span> <span class="n">amplitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span>

                    <span class="c1"># Update image data instead of recreating</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">real_part</span><span class="p">)</span>

                    <span class="c1"># Show fraction of period completed</span>
                    <span class="n">period_fraction</span> <span class="o">=</span> <span class="n">t</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Re[m_</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">] @ </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz (t = </span><span class="si">{</span><span class="n">period_fraction</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">T)&quot;</span>
                    <span class="p">)</span>

                    <span class="k">return</span> <span class="p">[</span><span class="n">im</span><span class="p">]</span>

                <span class="c1"># Create animation</span>
                <span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span>
                    <span class="n">fig</span><span class="p">,</span>
                    <span class="n">animate_temporal</span><span class="p">,</span>
                    <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">),</span>
                    <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span>
                    <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">animation_type</span> <span class="o">==</span> <span class="s2">&quot;frequency&quot;</span> <span class="ow">and</span> <span class="n">frequency_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Frequency sweep animation</span>
                <span class="n">f_min</span><span class="p">,</span> <span class="n">f_max</span> <span class="o">=</span> <span class="n">frequency_range</span>
                <span class="n">freq_mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">&gt;=</span> <span class="n">f_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">&lt;=</span> <span class="n">f_max</span><span class="p">)</span>
                <span class="n">freq_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">freq_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No frequencies found in specified range&quot;</span><span class="p">)</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Creating frequency sweep animation: </span><span class="si">{</span><span class="n">f_min</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">f_max</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span>
                <span class="p">)</span>

                <span class="c1"># Pre-calculate all mode data for consistent normalization</span>
                <span class="n">all_amplitudes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">freq_idx</span> <span class="ow">in</span> <span class="n">freq_indices</span><span class="p">:</span>
                    <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="n">freq_idx</span><span class="p">]</span>
                    <span class="n">mode_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">)</span>
                    <span class="n">comp_data</span> <span class="o">=</span> <span class="n">mode_data</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
                    <span class="n">all_amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">comp_data</span><span class="p">))</span>

                <span class="c1"># Global normalization</span>
                <span class="n">global_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span> <span class="k">for</span> <span class="n">amp</span> <span class="ow">in</span> <span class="n">all_amplitudes</span><span class="p">])</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">global_max</span><span class="p">)</span>

                <span class="c1"># Create initial plot for colorbar setup</span>
                <span class="n">mode_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="n">freq_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">z_layer</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">all_amplitudes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                    <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                    <span class="n">extent</span><span class="o">=</span><span class="n">mode_data</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
                    <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Create colorbar once</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;|Magnetization| (arb. units)&quot;</span><span class="p">)</span>

                <span class="c1"># Set labels once (they won&#39;t change)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x (nm)&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y (nm)&quot;</span><span class="p">)</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">animate_frequency</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
                    <span class="n">freq_idx</span> <span class="o">=</span> <span class="n">freq_indices</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
                    <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="n">freq_idx</span><span class="p">]</span>
                    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">all_amplitudes</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>

                    <span class="c1"># Update image data instead of recreating</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;|m_</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">| @ </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span><span class="p">)</span>

                    <span class="k">return</span> <span class="p">[</span><span class="n">im</span><span class="p">]</span>

                <span class="c1"># Create animation</span>
                <span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span>
                    <span class="n">fig</span><span class="p">,</span>
                    <span class="n">animate_frequency</span><span class="p">,</span>
                    <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">freq_indices</span><span class="p">),</span>
                    <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span>
                    <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">animation_type</span> <span class="o">==</span> <span class="s2">&quot;phase&quot;</span> <span class="ow">and</span> <span class="n">frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Phase evolution animation</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating phase animation at </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz&quot;</span><span class="p">)</span>

                <span class="n">mode_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">z_layer</span><span class="p">)</span>
                <span class="n">comp_data</span> <span class="o">=</span> <span class="n">mode_data</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>

                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">comp_data</span><span class="p">)</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">comp_data</span><span class="p">)</span>

                <span class="c1"># Phase steps</span>
                <span class="n">phase_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">animation_time_steps</span>
                <span class="p">)</span>

                <span class="c1"># Create initial plot for colorbar setup</span>
                <span class="n">current_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase</span> <span class="o">+</span> <span class="n">phase_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">current_phase</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;hsv&quot;</span><span class="p">,</span>  <span class="c1"># HSV is perfect for phase</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                    <span class="n">extent</span><span class="o">=</span><span class="n">mode_data</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
                    <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Create colorbar once</span>
                <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Phase (rad)&quot;</span><span class="p">)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;π/2&quot;</span><span class="p">,</span> <span class="s2">&quot;π&quot;</span><span class="p">,</span> <span class="s2">&quot;3π/2&quot;</span><span class="p">,</span> <span class="s2">&quot;2π&quot;</span><span class="p">])</span>

                <span class="c1"># Set labels once (they won&#39;t change)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x (nm)&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y (nm)&quot;</span><span class="p">)</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">animate_phase</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
                    <span class="c1"># Add phase offset</span>
                    <span class="n">current_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase</span> <span class="o">+</span> <span class="n">phase_steps</span><span class="p">[</span><span class="n">frame</span><span class="p">])</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

                    <span class="c1"># Update image data instead of recreating</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">current_phase</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Phase[m_</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">] @ </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GHz (φ offset = </span><span class="si">{</span><span class="n">phase_steps</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>

                    <span class="k">return</span> <span class="p">[</span><span class="n">im</span><span class="p">]</span>

                <span class="c1"># Create animation</span>
                <span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span>
                    <span class="n">fig</span><span class="p">,</span>
                    <span class="n">animate_phase</span><span class="p">,</span>
                    <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">phase_steps</span><span class="p">),</span>
                    <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span>
                    <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid animation_type &#39;</span><span class="si">{</span><span class="n">animation_type</span><span class="si">}</span><span class="s2">&#39; for given parameters&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Save animation</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="c1"># Choose writer based on file extension with fallback support</span>
            <span class="k">if</span> <span class="n">save_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mp4&quot;</span><span class="p">):</span>
                <span class="c1"># Check if ffmpeg is actually available on the system</span>
                <span class="k">if</span> <span class="n">FFMPEG_AVAILABLE</span> <span class="ow">and</span> <span class="n">check_ffmpeg_available</span><span class="p">():</span>
                    <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;ffmpeg&quot;</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using FFmpeg writer for MP4 format&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;FFmpeg not available on system, converting to GIF format&quot;</span>
                    <span class="p">)</span>
                    <span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mp4&quot;</span><span class="p">,</span> <span class="s2">&quot;.gif&quot;</span><span class="p">)</span>
                    <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;pillow&quot;</span>
            <span class="k">elif</span> <span class="n">save_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gif&quot;</span><span class="p">):</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;pillow&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="s2">&quot;pillow&quot;</span>  <span class="c1"># Default to GIF</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">save_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gif&quot;</span><span class="p">):</span>
                    <span class="n">save_path</span> <span class="o">+=</span> <span class="s2">&quot;.gif&quot;</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving animation to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2"> (this may take a while...)&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># For MP4, use higher quality settings</span>
                <span class="k">if</span> <span class="n">writer</span> <span class="o">==</span> <span class="s2">&quot;ffmpeg&quot;</span> <span class="ow">and</span> <span class="n">save_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mp4&quot;</span><span class="p">):</span>
                    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                        <span class="n">save_path</span><span class="p">,</span>
                        <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span>
                        <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                        <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dpi</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-vcodec&quot;</span><span class="p">,</span> <span class="s2">&quot;libx264&quot;</span><span class="p">,</span> <span class="s2">&quot;-pix_fmt&quot;</span><span class="p">,</span> <span class="s2">&quot;yuv420p&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                        <span class="n">save_path</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dpi</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="p">)</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Animation saved successfully!&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">save_error</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save animation with </span><span class="si">{</span><span class="n">writer</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">save_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Fallback to GIF if MP4 fails</span>
                <span class="k">if</span> <span class="n">writer</span> <span class="o">==</span> <span class="s2">&quot;ffmpeg&quot;</span> <span class="ow">and</span> <span class="n">save_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mp4&quot;</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting fallback to GIF format...&quot;</span><span class="p">)</span>
                    <span class="n">fallback_path</span> <span class="o">=</span> <span class="n">save_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.mp4&quot;</span><span class="p">,</span> <span class="s2">&quot;.gif&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                            <span class="n">fallback_path</span><span class="p">,</span>
                            <span class="n">writer</span><span class="o">=</span><span class="s2">&quot;pillow&quot;</span><span class="p">,</span>
                            <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                            <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dpi</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Animation saved as GIF: </span><span class="si">{</span><span class="n">fallback_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">gif_error</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fallback to GIF also failed: </span><span class="si">{</span><span class="n">gif_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">save_error</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">save_error</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animation requires additional packages: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create animation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>
</div>



<div class="viewcode-block" id="FFTModeInterface">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FFTModeInterface">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FFTModeInterface</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enhanced FFT interface with mode visualization capabilities.</span>

<span class="sd">    Provides elegant syntax like: op[0].fft[0][200].plot_modes()</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FFTModeInterface.__init__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FFTModeInterface.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fft_result_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">parent_fft</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize mode interface for specific FFT result.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fft_result_index</span> <span class="o">=</span> <span class="n">fft_result_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span> <span class="o">=</span> <span class="n">parent_fft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode_analyzer</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FFTModeInterface.__getitem__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FFTModeInterface.__getitem__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FrequencyModeInterface&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get mode interface for specific frequency index.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FrequencyModeInterface</span><span class="p">(</span><span class="n">frequency_index</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="FFTModeInterface.__repr__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FFTModeInterface.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rich representation of the FFT mode interface.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">rich.console</span><span class="w"> </span><span class="kn">import</span> <span class="n">Console</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">rich.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">Text</span>

            <span class="n">RICH_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">RICH_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">RICH_AVAILABLE</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span>
            <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span><span class="p">,</span> <span class="s2">&quot;_interactive_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rich_modes_display</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basic_modes_display</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_rich_modes_display</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate rich display for FFT modes interface.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">rich.console</span><span class="w"> </span><span class="kn">import</span> <span class="n">Console</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">rich.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">Text</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">rich.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">rich.columns</span><span class="w"> </span><span class="kn">import</span> <span class="n">Columns</span>

            <span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>

            <span class="n">summary_text</span> <span class="o">=</span> <span class="n">Text</span><span class="p">()</span>
            <span class="n">summary_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;🎯 MMPP FFT Mode Analyzer</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold cyan&quot;</span><span class="p">)</span>
            <span class="n">summary_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📁 Dataset: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dataset_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not loaded&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dim&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">summary_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;🌊 Modes available: </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;modes_available&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dim&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">summary_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📊 Z-layers: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;n_z_layers&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dim&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">methods_text</span> <span class="o">=</span> <span class="n">Text</span><span class="p">()</span>
            <span class="n">methods_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;🔧 Available methods:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold yellow&quot;</span><span class="p">)</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span>
                    <span class="s2">&quot;interactive_spectrum(dset=None, **kwargs)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Interactive spectrum with modes&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;plot_modes(frequency, dset=None, **kwargs)&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Plot mode at specific frequency&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;save_modes_animation(**kwargs)&quot;</span><span class="p">,</span> <span class="s2">&quot;Create mode animations&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;compute_modes(dset=None, **kwargs)&quot;</span><span class="p">,</span> <span class="s2">&quot;Compute/recompute modes&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;[freq_index].plot_modes(**kwargs)&quot;</span><span class="p">,</span> <span class="s2">&quot;Plot modes at frequency index&quot;</span><span class="p">),</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="n">methods_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  • &quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dim&quot;</span><span class="p">)</span>
                <span class="n">methods_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
                <span class="n">methods_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dim&quot;</span><span class="p">)</span>

            <span class="n">examples_text</span> <span class="o">=</span> <span class="n">Text</span><span class="p">()</span>
            <span class="n">examples_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;💡 Usage examples:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold green&quot;</span><span class="p">)</span>
            <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;modes.interactive_spectrum(dset=&#39;m_z11&#39;)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;modes.plot_modes(frequency=1.5, dset=&#39;m_z11&#39;)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;modes.save_modes_animation(frequency=1.5, animation_type=&#39;temporal&#39;)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;modes[0][150].plot_modes()  # freq index 0, freq point 150&quot;</span><span class="p">,</span>
                <span class="s2">&quot;modes.compute_modes(dset=&#39;m_z5-8&#39;)&quot;</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
                <span class="n">examples_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">example</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">console</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span> <span class="k">as</span> <span class="n">capture</span><span class="p">:</span>
                    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                        <span class="n">Panel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                            <span class="n">summary_text</span><span class="p">,</span>
                            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;[bold blue]MMPP FFT Modes[/bold blue]&quot;</span><span class="p">,</span>
                            <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                        <span class="n">Columns</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">Panel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                                    <span class="n">methods_text</span><span class="p">,</span>
                                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;[bold yellow]Methods[/bold yellow]&quot;</span><span class="p">,</span>
                                    <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
                                <span class="p">),</span>
                                <span class="n">Panel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                                    <span class="n">examples_text</span><span class="p">,</span>
                                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;[bold green]Examples[/bold green]&quot;</span><span class="p">,</span>
                                    <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                                <span class="p">),</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">capture</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">summary_text</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">methods_text</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">examples_text</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basic_modes_display</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_basic_modes_display</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate basic display for FFT modes interface.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">MMPP FFT Mode Analyzer:</span>
<span class="s2">======================</span>
<span class="s2">🎯 Advanced FMR mode visualization and analysis</span>
<span class="s2">📁 Dataset: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dataset_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not loaded&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">🌊 Modes available: </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;modes_available&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No&#39;</span><span class="si">}</span>
<span class="s2">📊 Z-layers: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;n_z_layers&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span>

<span class="s2">🔧 Main methods:</span>
<span class="s2">  • interactive_spectrum(dset=None, **kwargs) - Interactive spectrum with modes</span>
<span class="s2">  • plot_modes(frequency, dset=None, **kwargs) - Plot mode at specific frequency  </span>
<span class="s2">  • save_modes_animation(**kwargs) - Create mode animations</span>
<span class="s2">  • compute_modes(dset=None, **kwargs) - Compute/recompute modes</span>
<span class="s2">  • [freq_index].plot_modes(**kwargs) - Plot modes at frequency index</span>

<span class="s2">💡 Animation examples:</span>
<span class="s2">  • modes.save_modes_animation(frequency=1.5, animation_type=&#39;temporal&#39;)</span>
<span class="s2">  • modes.save_modes_animation(frequency_range=(1.0, 3.0), animation_type=&#39;frequency&#39;)</span>
<span class="s2">  </span>
<span class="s2">🎬 Animation types: &#39;temporal&#39;, &#39;frequency&#39;, &#39;phase&#39;</span>
<span class="s2">🎨 Supports MP4 (ffmpeg) and GIF (pillow) output formats</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mode_analyzer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FMRModeAnalyzer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or create mode analyzer (lazy initialization).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_analyzer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get zarr path from parent FFT</span>
            <span class="n">zarr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">job_result</span><span class="o">.</span><span class="n">path</span>
            <span class="n">debug_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span>
                <span class="k">else</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode_analyzer</span> <span class="o">=</span> <span class="n">FMRModeAnalyzer</span><span class="p">(</span><span class="n">zarr_path</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug_mode</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode_analyzer</span>

<div class="viewcode-block" id="FFTModeInterface.interactive_spectrum">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FFTModeInterface.interactive_spectrum">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">interactive_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create interactive spectrum plot.&quot;&quot;&quot;</span>
        <span class="c1"># If dset is specified, create a new analyzer for that dataset</span>
        <span class="k">if</span> <span class="n">dset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dset</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">:</span>
            <span class="n">zarr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">job_result</span><span class="o">.</span><span class="n">path</span>
            <span class="n">debug_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span>
                <span class="k">else</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">temp_analyzer</span> <span class="o">=</span> <span class="n">FMRModeAnalyzer</span><span class="p">(</span>
                <span class="n">zarr_path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug_mode</span>
            <span class="p">)</span>

            <span class="c1"># Check if modes exist, if not compute them</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">modes_available</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing modes for dataset &#39;</span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
                <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">interactive_spectrum</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use default analyzer</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">modes_available</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Computing modes for dataset &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">interactive_spectrum</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FFTModeInterface.compute_modes">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FFTModeInterface.compute_modes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute modes for specified dataset.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zarr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">job_result</span><span class="o">.</span><span class="n">path</span>
            <span class="n">debug_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span>
                <span class="k">else</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">temp_analyzer</span> <span class="o">=</span> <span class="n">FMRModeAnalyzer</span><span class="p">(</span>
                <span class="n">zarr_path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug_mode</span>
            <span class="p">)</span>
            <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FFTModeInterface.plot_modes">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FFTModeInterface.plot_modes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_modes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Figure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot modes at specified frequency.&quot;&quot;&quot;</span>
        <span class="c1"># If dset is specified, create a new analyzer for that dataset</span>
        <span class="k">if</span> <span class="n">dset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dset</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">:</span>
            <span class="n">zarr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">job_result</span><span class="o">.</span><span class="n">path</span>
            <span class="n">debug_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span>
                <span class="k">else</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">temp_analyzer</span> <span class="o">=</span> <span class="n">FMRModeAnalyzer</span><span class="p">(</span>
                <span class="n">zarr_path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug_mode</span>
            <span class="p">)</span>

            <span class="c1"># Check if modes exist, if not compute them</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">modes_available</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing modes for dataset &#39;</span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
                <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">plot_modes</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use default analyzer</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">modes_available</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Computing modes for dataset &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">plot_modes</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FFTModeInterface.save_modes_animation">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FFTModeInterface.save_modes_animation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_modes_animation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frequency_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mode_animation.gif&quot;</span><span class="p">,</span>
        <span class="n">dset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
        <span class="n">z_layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">component</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
        <span class="n">animation_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;temporal&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save animation of FMR modes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        frequency_range : tuple, optional</span>
<span class="sd">            (f_min, f_max) in GHz for frequency sweep animation</span>
<span class="sd">        frequency : float, optional</span>
<span class="sd">            Single frequency for temporal animation (in GHz)</span>
<span class="sd">        save_path : str</span>
<span class="sd">            Output file path (.gif or .mp4)</span>
<span class="sd">        dset : str, optional</span>
<span class="sd">            Dataset name. If None, uses default analyzer</span>
<span class="sd">        fps : int</span>
<span class="sd">            Frames per second (default: 15)</span>
<span class="sd">        z_layer : int</span>
<span class="sd">            Z-layer to animate (default: 0)</span>
<span class="sd">        component : str or int</span>
<span class="sd">            Component to animate (default: &#39;z&#39;)</span>
<span class="sd">        animation_type : str</span>
<span class="sd">            Type of animation (&#39;temporal&#39;, &#39;frequency&#39;, &#39;phase&#39;)</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional arguments passed to FMRModeAnalyzer.save_modes_animation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If dset is specified, create a new analyzer for that dataset</span>
        <span class="k">if</span> <span class="n">dset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dset</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">:</span>
            <span class="n">zarr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">job_result</span><span class="o">.</span><span class="n">path</span>
            <span class="n">debug_mode</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_fft</span><span class="o">.</span><span class="n">mmpp</span>
                <span class="k">else</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">temp_analyzer</span> <span class="o">=</span> <span class="n">FMRModeAnalyzer</span><span class="p">(</span>
                <span class="n">zarr_path</span><span class="p">,</span> <span class="n">dataset_name</span><span class="o">=</span><span class="n">dset</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug_mode</span>
            <span class="p">)</span>

            <span class="c1"># Check if modes exist, if not compute them</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">modes_available</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing modes for dataset &#39;</span><span class="si">{</span><span class="n">dset</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
                <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">temp_analyzer</span><span class="o">.</span><span class="n">save_modes_animation</span><span class="p">(</span>
                <span class="n">frequency_range</span><span class="o">=</span><span class="n">frequency_range</span><span class="p">,</span>
                <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span>
                <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                <span class="n">z_layer</span><span class="o">=</span><span class="n">z_layer</span><span class="p">,</span>
                <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                <span class="n">animation_type</span><span class="o">=</span><span class="n">animation_type</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use default analyzer</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">modes_available</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Computing modes for dataset &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">compute_modes</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">save_modes_animation</span><span class="p">(</span>
                <span class="n">frequency_range</span><span class="o">=</span><span class="n">frequency_range</span><span class="p">,</span>
                <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span>
                <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                <span class="n">z_layer</span><span class="o">=</span><span class="n">z_layer</span><span class="p">,</span>
                <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
                <span class="n">animation_type</span><span class="o">=</span><span class="n">animation_type</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="FrequencyModeInterface">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FrequencyModeInterface">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FrequencyModeInterface</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface for mode operations at a specific frequency.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FrequencyModeInterface.__init__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FrequencyModeInterface.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">parent_mode_interface</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize frequency-specific mode interface.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency_index</span> <span class="o">=</span> <span class="n">frequency_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent_mode_interface</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get frequency value for this index.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">frequencies</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency_index</span><span class="p">]</span>

<div class="viewcode-block" id="FrequencyModeInterface.plot_modes">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FrequencyModeInterface.plot_modes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Figure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot modes at this frequency.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">plot_modes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FrequencyModeInterface.get_mode">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FrequencyModeInterface.get_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FMRModeData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get mode data at this frequency.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FrequencyModeInterface.__repr__">
<a class="viewcode-back" href="../../../api/fft/modes.html#mmpp.fft.modes.FrequencyModeInterface.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rich string representation of FrequencyModeInterface.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try rich display first</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rich_frequency_display</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="c1"># Fallback to basic display</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basic_frequency_display</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_rich_frequency_display</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rich display with styling and detailed information.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rich.console</span><span class="w"> </span><span class="kn">import</span> <span class="n">Console</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rich.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rich.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">Text</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rich.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">rich.syntax</span><span class="w"> </span><span class="kn">import</span> <span class="n">Syntax</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">io</span>

        <span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">force_terminal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Main header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="s2">&quot;FrequencyModeInterface&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold cyan&quot;</span><span class="p">)</span>

        <span class="c1"># Frequency information table</span>
        <span class="n">freq_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">show_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">freq_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Property&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold yellow&quot;</span><span class="p">)</span>
        <span class="n">freq_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

        <span class="n">freq_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;🎯 Frequency Index&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">freq_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;⚡ Frequency Value&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>
        <span class="n">freq_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
            <span class="s2">&quot;📊 Parent Modes&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span><span class="si">}</span><span class="s2"> frequencies&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Available methods</span>
        <span class="n">methods_text</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="s2">&quot;Available Methods:&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold green&quot;</span><span class="p">)</span>
        <span class="n">methods_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;• plot_modes(**kwargs) → Tuple[Figure, np.ndarray]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;• get_mode(**kwargs) → FMRModeData&quot;</span><span class="p">,</span>
            <span class="s2">&quot;• frequency → float (property)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">methods_content</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">methods_list</span><span class="p">)</span>

        <span class="c1"># Usage examples</span>
        <span class="n">example_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;# Access frequency-specific operations</span>
<span class="s2">freq_interface = modes[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency_index</span><span class="si">}</span><span class="s2">]</span>

<span class="s2"># Plot modes at this frequency</span>
<span class="s2">fig, axes = freq_interface.plot_modes()</span>

<span class="s2"># Get mode data</span>
<span class="s2">mode_data = freq_interface.get_mode()</span>

<span class="s2"># Check frequency value</span>
<span class="s2">print(f&quot;Frequency: </span><span class="se">{{</span><span class="s2">freq_interface.frequency:.2e</span><span class="se">}}</span><span class="s2"> Hz&quot;)&quot;&quot;&quot;</span>

        <span class="n">syntax</span> <span class="o">=</span> <span class="n">Syntax</span><span class="p">(</span>
            <span class="n">example_code</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s2">&quot;monokai&quot;</span><span class="p">,</span> <span class="n">background_color</span><span class="o">=</span><span class="s2">&quot;default&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Build the panel content</span>
        <span class="n">content_parts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">freq_table</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">methods_text</span><span class="p">,</span>
            <span class="n">Text</span><span class="p">(</span><span class="n">methods_content</span><span class="p">),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">Text</span><span class="p">(</span><span class="s2">&quot;Usage Examples:&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold blue&quot;</span><span class="p">),</span>
            <span class="n">syntax</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">panel</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">content_parts</span><span class="p">),</span>
            <span class="n">title</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">),</span>
            <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">98</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">panel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">console</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_basic_frequency_display</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Basic fallback display without rich formatting.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;FrequencyModeInterface(frequency_index=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency_index</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;frequency=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> Hz)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Methods: plot_modes(), get_mode(), frequency (property)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Parent analyzer has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mode_analyzer</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)</span><span class="si">}</span><span class="s2"> frequencies&quot;</span>
        <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mateusz Zelent.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>